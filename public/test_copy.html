<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy Function Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h2>Copy Function Test</h2>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="testText" value="https://example.com/test-referral-link" readonly>
                    <button class="btn btn-primary" type="button" id="testCopyButton" onclick="testCopyLink()">
                        <i class="ri-file-copy-line me-1"></i> Copy
                    </button>
                </div>
                <div id="testResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        async function testCopyLink() {
            console.log('testCopyLink function called');
            
            const testText = document.getElementById('testText').value;
            const copyButton = document.getElementById('testCopyButton');
            const resultDiv = document.getElementById('testResult');
            
            const originalButtonContent = copyButton.innerHTML;
            
            try {
                // Disable button and show loading state
                copyButton.disabled = true;
                copyButton.innerHTML = '<i class="ri-loader-4-line me-1"></i> Copying...';
                resultDiv.innerHTML = '<div class="alert alert-info">Attempting to copy...</div>';
                
                console.log('Trying to copy:', testText);
                
                let success = false;
                
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    console.log('Using modern clipboard API');
                    try {
                        await navigator.clipboard.writeText(testText);
                        success = true;
                        console.log('Modern clipboard API success');
                    } catch (clipboardError) {
                        console.warn('Modern clipboard API failed:', clipboardError);
                        success = fallbackCopyToClipboard(testText);
                    }
                } else {
                    console.log('Using fallback method');
                    success = fallbackCopyToClipboard(testText);
                }
                
                if (success) {
                    // Show success state
                    copyButton.innerHTML = '<i class="ri-check-line me-1"></i> Copied!';
                    copyButton.classList.add('btn-success');
                    copyButton.classList.remove('btn-primary');
                    resultDiv.innerHTML = '<div class="alert alert-success">✅ Copy successful!</div>';
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        copyButton.innerHTML = originalButtonContent;
                        copyButton.classList.remove('btn-success');
                        copyButton.classList.add('btn-primary');
                        copyButton.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('All copy methods failed');
                }
                
            } catch (err) {
                console.error('Failed to copy text: ', err);
                
                // Show error state
                copyButton.innerHTML = '<i class="ri-error-warning-line me-1"></i> Failed';
                copyButton.classList.add('btn-danger');
                copyButton.classList.remove('btn-primary');
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ Copy failed: ' + err.message + '</div>';
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    copyButton.innerHTML = originalButtonContent;
                    copyButton.classList.remove('btn-danger');
                    copyButton.classList.add('btn-primary');
                    copyButton.disabled = false;
                }, 3000);
                
                // Focus and select the input field for manual copying
                const inputField = document.getElementById('testText');
                inputField.focus();
                inputField.select();
            }
        }
        
        function fallbackCopyToClipboard(text) {
            console.log('Fallback copy method called with:', text);
            
            try {
                // Method 1: Using textarea
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                textArea.setAttribute('readonly', '');
                textArea.style.contain = 'strict';
                
                document.body.appendChild(textArea);
                
                // For mobile devices
                if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
                    console.log('iOS device detected');
                    textArea.contentEditable = true;
                    textArea.readOnly = false;
                    const range = document.createRange();
                    range.selectNodeContents(textArea);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    textArea.setSelectionRange(0, 999999);
                } else {
                    textArea.select();
                    textArea.focus();
                }
                
                const successful = document.execCommand('copy');
                textArea.remove();
                
                console.log('execCommand copy result:', successful);
                
                if (successful) {
                    return true;
                }
                
                // Method 2: Using the original input field
                console.log('Trying method 2 - input field selection');
                const inputField = document.getElementById('testText');
                inputField.focus();
                inputField.select();
                
                const result = document.execCommand('copy');
                console.log('Method 2 result:', result);
                return result;
                
            } catch (err) {
                console.error('Fallback copy failed:', err);
                return false;
            }
        }
        
        // Check browser support
        document.addEventListener('DOMContentLoaded', function() {
            const supportDiv = document.createElement('div');
            supportDiv.className = 'alert alert-info mt-3';
            
            let supportInfo = '<strong>Browser Support:</strong><br>';
            supportInfo += 'Clipboard API: ' + (navigator.clipboard ? '✅ Available' : '❌ Not available') + '<br>';
            supportInfo += 'Secure Context: ' + (window.isSecureContext ? '✅ Yes' : '❌ No') + '<br>';
            supportInfo += 'execCommand: ' + (document.queryCommandSupported('copy') ? '✅ Supported' : '❌ Not supported') + '<br>';
            supportInfo += 'User Agent: ' + navigator.userAgent;
            
            supportDiv.innerHTML = supportInfo;
            document.querySelector('.container').appendChild(supportDiv);
        });
    </script>
</body>
</html>
