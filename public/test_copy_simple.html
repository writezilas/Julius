<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Copy Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">üìã Simple Copy Function Test</h4>
                        <small class="text-muted">Test the exact same copy function used in the referrals page</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Test Referral Link:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="referralCode" 
                                       value="http://127.0.0.1:8001/register?refferal_code=testuser" readonly>
                                <button class="btn btn-light" type="button" id="copyButton" onclick="handleCopyLink()">
                                    <i class="ri-file-copy-line me-1"></i> Copy
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Instructions:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Click the "Copy" button above</li>
                                <li>Watch for visual feedback (button changes color)</li>
                                <li>Try pasting in another app to verify it worked</li>
                                <li>Check the browser console for debugging info</li>
                            </ol>
                        </div>
                        
                        <div id="testResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Enhanced copy function with improved reliability and feedback
        function handleCopyLink() {
            console.log('üöÄ [TEST] Copy button clicked');
            
            const referralCode = document.getElementById('referralCode');
            const copyButton = document.getElementById('copyButton');
            
            if (!referralCode || !copyButton) {
                console.error('‚ùå [TEST] Required elements not found', {
                    referralCode: !!referralCode,
                    copyButton: !!copyButton
                });
                showNotification('‚ùå Copy button error - please refresh the page', 'error');
                return;
            }
            
            const referralCodeValue = referralCode.value.trim();
            
            if (!referralCodeValue) {
                console.error('‚ùå [TEST] No referral code to copy');
                showNotification('‚ùå No referral link available', 'error');
                return;
            }
            
            const originalButtonContent = copyButton.innerHTML;
            console.log('üìã [TEST] Attempting to copy:', referralCodeValue);
            
            // Disable button and show loading state
            copyButton.disabled = true;
            copyButton.innerHTML = '<i class="ri-loader-line me-1" style="animation: spin 1s linear infinite;"></i> Copying...';
            
            // Enhanced button reset function
            function resetButton(success = false, message = '') {
                const delay = success ? 2500 : 3500;
                const buttonClass = success ? 'btn-success' : 'btn-danger';
                const iconClass = success ? 'ri-check-line' : 'ri-error-warning-line';
                const text = success ? 'Copied!' : 'Try Again';
                
                // Show success/error state
                copyButton.innerHTML = `<i class="${iconClass} me-1"></i> ${text}`;
                copyButton.classList.remove('btn-light', 'btn-success', 'btn-danger');
                copyButton.classList.add(buttonClass);
                
                // Reset to original state after delay
                setTimeout(() => {
                    copyButton.innerHTML = originalButtonContent;
                    copyButton.classList.remove(buttonClass);
                    copyButton.classList.add('btn-light');
                    copyButton.disabled = false;
                }, delay);
            }
            
            // Method 1: Modern Clipboard API (preferred)
            if (navigator.clipboard && window.isSecureContext) {
                console.log('üîí [TEST] Using secure Clipboard API');
                
                navigator.clipboard.writeText(referralCodeValue)
                    .then(() => {
                        console.log('‚úÖ [TEST] Clipboard API success');
                        showNotification('‚úÖ Referral link copied successfully!', 'success');
                        resetButton(true);
                        
                        // Additional verification
                        verifyClipboardContent(referralCodeValue);
                    })
                    .catch((err) => {
                        console.warn('‚ö†Ô∏è [TEST] Clipboard API failed:', err.message);
                        console.log('üîÑ [TEST] Attempting fallback methods...');
                        tryFallbackMethods();
                    });
            } else {
                const reason = !navigator.clipboard ? 'Clipboard API not available' : 'Insecure context (HTTP)';
                console.log('‚ö†Ô∏è [TEST] ' + reason + ', using fallback methods');
                tryFallbackMethods();
            }
            
            // Enhanced fallback methods
            function tryFallbackMethods() {
                let methodWorked = false;
                
                // Method 2: execCommand with hidden textarea (most compatible)
                try {
                    console.log('üìù [TEST] Trying execCommand with textarea');
                    
                    const textarea = document.createElement('textarea');
                    textarea.value = referralCodeValue;
                    
                    // Position off-screen but ensure it's selectable
                    textarea.style.position = 'fixed';
                    textarea.style.top = '-9999px';
                    textarea.style.left = '-9999px';
                    textarea.style.opacity = '0';
                    textarea.style.pointerEvents = 'none';
                    textarea.style.tabIndex = '-1';
                    textarea.setAttribute('readonly', '');
                    
                    document.body.appendChild(textarea);
                    
                    // Select text with multiple methods for better compatibility
                    textarea.focus();
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                    
                    // Try the copy command
                    const success = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (success) {
                        console.log('‚úÖ [TEST] execCommand textarea method succeeded');
                        showNotification('‚úÖ Referral link copied to clipboard!', 'success');
                        resetButton(true);
                        methodWorked = true;
                        return;
                    } else {
                        console.log('‚ùå [TEST] execCommand returned false');
                    }
                } catch (err) {
                    console.log('‚ùå [TEST] execCommand textarea failed:', err.message);
                }
                
                // Method 3: Select the original input field
                if (!methodWorked) {
                    try {
                        console.log('üìù [TEST] Trying direct input selection');
                        
                        // Focus and select the input
                        referralCode.focus();
                        referralCode.select();
                        referralCode.setSelectionRange(0, referralCodeValue.length);
                        
                        // Try execCommand on the input
                        const success = document.execCommand('copy');
                        
                        if (success) {
                            console.log('‚úÖ [TEST] Direct input copy succeeded');
                            showNotification('‚úÖ Referral link copied to clipboard!', 'success');
                            resetButton(true);
                            methodWorked = true;
                            return;
                        } else {
                            console.log('‚ùå [TEST] Direct input copy returned false');
                        }
                    } catch (err) {
                        console.log('‚ùå [TEST] Direct input copy failed:', err.message);
                    }
                }
                
                // Method 4: Manual copy instruction (last resort)
                if (!methodWorked) {
                    console.log('üìã [TEST] All automatic methods failed, providing manual instruction');
                    
                    // Select the input field for manual copying
                    try {
                        referralCode.focus();
                        referralCode.select();
                        referralCode.setSelectionRange(0, referralCodeValue.length);
                    } catch (err) {
                        console.log('‚ö†Ô∏è [TEST] Could not select input field:', err.message);
                    }
                    
                    // Determine the correct key combination based on OS
                    const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
                    const keyCombo = isMac ? 'Cmd+C' : 'Ctrl+C';
                    
                    showNotification(
                        `üìã Manual copy required: The referral link is now selected. Please press ${keyCombo} to copy it.`,
                        'warning'
                    );
                    resetButton(false);
                }
            }
            
            // Optional: Verify clipboard content (for debugging)
            function verifyClipboardContent(expectedValue) {
                if (navigator.clipboard && navigator.clipboard.readText && window.isSecureContext) {
                    setTimeout(() => {
                        navigator.clipboard.readText()
                            .then(clipboardContent => {
                                if (clipboardContent === expectedValue) {
                                    console.log('‚úÖ [TEST] Clipboard verification: Content matches');
                                } else {
                                    console.log('‚ö†Ô∏è [TEST] Clipboard verification: Content differs');
                                    console.log('[TEST] Expected:', expectedValue);
                                    console.log('[TEST] Actual:', clipboardContent);
                                }
                            })
                            .catch(err => {
                                // Silent fail - verification is optional
                                console.log('‚ÑπÔ∏è [TEST] Clipboard verification not possible:', err.message);
                            });
                    }, 100);
                }
            }
        }
        
        // Simple notification function
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                resultsDiv.innerHTML = '';
            }, 5000);
        }
        
        // Display browser support info
        document.addEventListener('DOMContentLoaded', function() {
            const browserInfo = `
                <div class="alert alert-secondary">
                    <strong>Browser Support:</strong><br>
                    ‚Ä¢ Clipboard API: ${navigator.clipboard ? '‚úÖ Available' : '‚ùå Not available'}<br>
                    ‚Ä¢ Secure Context (HTTPS): ${window.isSecureContext ? '‚úÖ Yes' : '‚ùå No (using HTTP)'}<br>
                    ‚Ä¢ execCommand: ${document.queryCommandSupported && document.queryCommandSupported('copy') ? '‚úÖ Supported' : '‚ùå Not supported'}<br>
                    ‚Ä¢ User Agent: ${navigator.userAgent.slice(0, 50)}...
                </div>
            `;
            document.getElementById('testResults').innerHTML = browserInfo;
        });
    </script>
</body>
</html>
</html>
